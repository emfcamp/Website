"""Create redeemed column, remove old admissionticket checked_in/badged_up columns

Revision ID: 4517a0be1564
Revises: b9db98f438aa
Create Date: 2024-05-14 22:25:37.096242

"""

# revision identifiers, used by Alembic.
revision = '4517a0be1564'
down_revision = 'b9db98f438aa'

from alembic import op
import sqlalchemy as sa
from sqlalchemy.ext.declarative import declarative_base

from main import db

Base = declarative_base()

class ProductGroup(Base):
    __tablename__ = 'product_group'
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String, unique=True, nullable=False)
    attributes = db.Column(db.JSON, default={})


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('purchase', sa.Column('redeemed', sa.Boolean(), nullable=True))
    op.drop_column('purchase', 'badge_issued')
    op.drop_column('purchase', 'checked_in')
    op.add_column('purchase_version', sa.Column('redeemed', sa.Boolean(), autoincrement=False, nullable=True))
    op.drop_column('purchase_version', 'badge_issued')
    op.drop_column('purchase_version', 'checked_in')
    # ### end Alembic commands ###

    # Mark 'admissions'/'merchandise' as redeemable.
    bind = op.get_bind()
    session = sa.orm.Session(bind=bind)

    for pg in session.query(ProductGroup):
        if pg.name in ('merchandise', 'admissions'):
            attrs = pg.attributes.copy()
            attrs['is_redeemable'] = True
            pg.attributes = attrs
            session.add(pg)

    session.commit()


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('purchase_version', sa.Column('checked_in', sa.BOOLEAN(), autoincrement=False, nullable=True))
    op.add_column('purchase_version', sa.Column('badge_issued', sa.BOOLEAN(), autoincrement=False, nullable=True))
    op.drop_column('purchase_version', 'redeemed')
    op.add_column('purchase', sa.Column('checked_in', sa.BOOLEAN(), autoincrement=False, nullable=True))
    op.add_column('purchase', sa.Column('badge_issued', sa.BOOLEAN(), autoincrement=False, nullable=True))
    op.drop_column('purchase', 'redeemed')
    # ### end Alembic commands ###
